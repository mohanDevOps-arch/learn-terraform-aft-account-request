name: ðŸš€ Create AWS Account Request

# Simple workflow - runs directly in account-request repository
on:
  workflow_dispatch:
    inputs:
      account_name:
        description: 'ðŸ“ Account Name'
        required: true
        type: string
      
      account_email:
        description: 'ðŸ“§ Unique Account Email'
        required: true
        type: string
      
      organizational_unit:
        description: 'ðŸ¢ Organizational Unit'
        required: true
        type: choice
        options:
          - LearnMck
          - AFTLearn
      
      environment:
        description: 'ðŸŒ Environment'
        required: true
        type: choice
        options:
          - Development
          - Testing
          - Staging
          - Production

jobs:
  create-request:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "AFT Automation"
          git config user.email "aft-automation@github.com"
      
      - name: ðŸ“ Create Account Request
        run: |
          # Generate safe module name
          MODULE_NAME=$(echo "${{ inputs.account_name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_')
          TIMESTAMP=$(date +%s)
          
          # Append to main.tf
          cat >> terraform/main.tf << 'EOF'
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Account: ${{ inputs.account_name }}
          # Created: $(date '+%Y-%m-%d %H:%M:%S UTC')
          # Requested by: ${{ github.actor }}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          module "${{ inputs.account_name | lower | replace(' ', '_') }}_TIMESTAMP" {
            source = "./modules/aft-account-request"
          
            control_tower_parameters = {
              AccountEmail              = "${{ inputs.account_email }}"
              AccountName               = "${{ inputs.account_name }}"
              ManagedOrganizationalUnit = "${{ inputs.organizational_unit }}"
              SSOUserEmail              = "ravish.snkhyn@gmail.com"
              SSOUserFirstName          = "Ravish"
              SSOUserLastName           = "Sankhyan"
            }
          
            account_tags = {
              "Environment"  = "${{ inputs.environment }}"
              "ManagedBy"    = "AFT"
              "RequestedBy"  = "${{ github.actor }}"
              "CreatedDate"  = "$(date +%Y-%m-%d)"
              "CreatedVia"   = "GitHub-Actions"
            }
          
            change_management_parameters = {
              change_requested_by = "${{ github.actor }}"
              change_reason       = "Account request via GitHub Actions"
            }
          
            custom_fields = {
              workflow_run_id = "${{ github.run_id }}"
              github_actor    = "${{ github.actor }}"
            }
          
            account_customizations_name = "sandbox"
          }
          EOF
          
          echo "âœ… Account request created!"
      
      - name: ðŸ’¾ Commit & Push
        run: |
          git add terraform/main.tf
          git commit -m "ðŸš€ New Account: ${{ inputs.account_name }}

          ðŸ“‹ Details:
          â€¢ Name: ${{ inputs.account_name }}
          â€¢ Email: ${{ inputs.account_email }}
          â€¢ OU: ${{ inputs.organizational_unit }}
          â€¢ Environment: ${{ inputs.environment }}
          â€¢ Requested by: ${{ github.actor }}
          
          âš™ï¸ Will be auto-processed by AFT in ~2 minutes"
          
          git push
          
          echo "âœ… Pushed successfully!"
      
      - name: ðŸŽ‰ Success Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ‰ Account Request Created!
          
          ### ðŸ“‹ Account Information
          | Field | Value |
          |-------|-------|
          | **Name** | ${{ inputs.account_name }} |
          | **Email** | ${{ inputs.account_email }} |
          | **OU** | ${{ inputs.organizational_unit }} |
          | **Environment** | ${{ inputs.environment }} |
          | **Requested By** | @${{ github.actor }} |
          
          ### â° What Happens Next?
          
          1. â±ï¸ **2 minutes** - EventBridge triggers CodePipeline
          2. ðŸ”§ **5 minutes** - Terraform creates DynamoDB entry
          3. ðŸ“¦ **10 minutes** - Lambda processes request
          4. ðŸ—ï¸ **15 minutes** - Service Catalog provisions account
          5. âœ… **20 minutes** - Account appears in Organizations
          
          ### ðŸ“Š Monitor Progress
          - [CodePipeline](https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view)
          - [AWS Organizations](https://console.aws.amazon.com/organizations/v2/home/accounts)
          
          ---
          ðŸ¤– Automated by AFT | ðŸ”’ Secured by Control Tower
          EOF

