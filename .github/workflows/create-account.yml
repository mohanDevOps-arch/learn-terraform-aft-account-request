name: üöÄ Create AWS Account Request

# Simple workflow - runs directly in account-request repository
on:
  workflow_dispatch:
    inputs:
      account_name:
        description: 'üìù Account Name'
        required: true
        type: string
      
      account_email:
        description: 'üìß Unique Account Email'
        required: true
        type: string
      
      organizational_unit:
        description: 'üè¢ Organizational Unit'
        required: true
        type: choice
        options:
          - LearnMck
          - Sandbox
          - Batch14
          - Batch15
          - AFT-Lab-Rajesh
          - Security
          - SuspendedAccount
      
      environment:
        description: 'üåç Environment'
        required: true
        type: choice
        options:
          - Development
          - Testing
          - Staging
          - Production

jobs:
  create-request:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Configure Git
        run: |
          git config user.name "AFT Automation"
          git config user.email "aft-automation@github.com"
      
      - name: üìù Create Account Request
        run: |
          # Generate safe module name
          MODULE_NAME=$(echo "${{ inputs.account_name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_')
          TIMESTAMP=$(date +%s)
          
          # Append to main.tf
          cat >> terraform/main.tf << EOF
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # Account: ${{ inputs.account_name }}
          # Created: $(date '+%Y-%m-%d %H:%M:%S UTC')
          # Requested by: ${{ github.actor }}
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          module "${MODULE_NAME}_${TIMESTAMP}" {
            source = "./modules/aft-account-request"
          
            control_tower_parameters = {
              AccountEmail              = "${{ inputs.account_email }}"
              AccountName               = "${{ inputs.account_name }}"
              ManagedOrganizationalUnit = "${{ inputs.organizational_unit }}"
              SSOUserEmail              = "ravish.snkhyn@gmail.com"
              SSOUserFirstName          = "Ravish"
              SSOUserLastName           = "Sankhyan"
            }
          
            account_tags = {
              "Environment"  = "${{ inputs.environment }}"
              "ManagedBy"    = "AFT"
              "RequestedBy"  = "${{ github.actor }}"
              "CreatedDate"  = "$(date +%Y-%m-%d)"
              "CreatedVia"   = "GitHub-Actions"
            }
          
            change_management_parameters = {
              change_requested_by = "${{ github.actor }}"
              change_reason       = "Account request via GitHub Actions"
            }
          
            custom_fields = {
              workflow_run_id = "${{ github.run_id }}"
              github_actor    = "${{ github.actor }}"
            }
          
            account_customizations_name = "sandbox"
          }
          EOF
          
          echo "‚úÖ Account request created!"
      
      - name: üíæ Commit & Push
        run: |
          # Pull latest changes first (in case other workflows ran)
          git pull --rebase origin main || true
          
          git add terraform/main.tf
          git commit -m "üöÄ New Account: ${{ inputs.account_name }}

          üìã Details:
          ‚Ä¢ Name: ${{ inputs.account_name }}
          ‚Ä¢ Email: ${{ inputs.account_email }}
          ‚Ä¢ OU: ${{ inputs.organizational_unit }}
          ‚Ä¢ Environment: ${{ inputs.environment }}
          ‚Ä¢ Requested by: ${{ github.actor }}
          
          ‚öôÔ∏è Will be auto-processed by AFT in ~2 minutes"
          
          # Push with retry logic
          for i in {1..3}; do
            if git push; then
              echo "‚úÖ Pushed successfully!"
              break
            else
              echo "‚ö†Ô∏è  Push failed, pulling and retrying..."
              git pull --rebase origin main
            fi
          done
      
      - name: ‚è∞ Wait for EventBridge Trigger
        run: |
          echo "‚è∞ Waiting 2 minutes for EventBridge to trigger CodePipeline..."
          sleep 120
          echo "‚úÖ EventBridge polling window passed"
      
      - name: üìä Monitor Account Creation (Full Process)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-south-1
          ACCOUNT_EMAIL: ${{ inputs.account_email }}
          ACCOUNT_NAME: ${{ inputs.account_name }}
          AFT_MGMT_ACCOUNT: "809574937450"
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä MONITORING ACCOUNT CREATION PROCESS"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "Account: $ACCOUNT_NAME"
          echo "Email: $ACCOUNT_EMAIL"
          echo ""
          
          MAX_WAIT=30  # Maximum 30 minutes
          CHECK_COUNT=0
          ACCOUNT_CREATED=false
          
          # Function to check if AWS credentials are configured
          check_aws_creds() {
            if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
              echo "‚ö†Ô∏è  AWS credentials not configured as secrets"
              echo "   Skipping automated monitoring"
              echo "   Please check manually at:"
              echo "   https://console.aws.amazon.com/organizations/v2/home/accounts"
              return 1
            fi
            return 0
          }
          
          if ! check_aws_creds; then
            echo ""
            echo "üí° To enable automated monitoring, add these GitHub secrets:"
            echo "   - AWS_ACCESS_KEY_ID"
            echo "   - AWS_SECRET_ACCESS_KEY"
            exit 0
          fi
          
          echo "‚úÖ AWS credentials configured"
          echo ""
          echo "üîÑ Assuming role in AFT Management account ($AFT_MGMT_ACCOUNT)..."
          
          # Assume role to AFT Management account
          ROLE_OUTPUT=$(aws sts assume-role \
            --role-arn "arn:aws:iam::${AFT_MGMT_ACCOUNT}:role/AWSControlTowerExecution" \
            --role-session-name "GitHubActions-Monitoring" \
            --duration-seconds 3600 2>&1)
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Failed to assume role to AFT Management account"
            echo "$ROLE_OUTPUT"
            echo ""
            echo "üí° Ensure Management account credentials have permission to assume AWSControlTowerExecution role"
            exit 1
          fi
          
          # Extract and export temporary credentials
          export AWS_ACCESS_KEY_ID=$(echo "$ROLE_OUTPUT" | jq -r '.Credentials.AccessKeyId')
          export AWS_SECRET_ACCESS_KEY=$(echo "$ROLE_OUTPUT" | jq -r '.Credentials.SecretAccessKey')
          export AWS_SESSION_TOKEN=$(echo "$ROLE_OUTPUT" | jq -r '.Credentials.SessionToken')
          
          echo "‚úÖ Successfully assumed role in AFT Management account"
          echo ""
          
          # Monitor loop
          for ((i=1; i<=MAX_WAIT; i++)); do
            CHECK_COUNT=$i
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚è∞ CHECK #$i/$MAX_WAIT - $(date '+%H:%M:%S')"
            echo ""
            
            # Check 1: CodePipeline Status
            echo "1Ô∏è‚É£ Checking CodePipeline..."
            PIPELINE_STATUS=$(aws codepipeline get-pipeline-state \
              --name ct-aft-account-request \
              --region ap-south-1 \
              --query 'stageStates[0].latestExecution.status' \
              --output text 2>/dev/null || echo "Unknown")
            echo "   Status: $PIPELINE_STATUS"
            
            # Check 2: DynamoDB Entry
            echo ""
            echo "2Ô∏è‚É£ Checking DynamoDB..."
            DDB_ENTRY=$(aws dynamodb get-item \
              --table-name aft-request \
              --key "{\"id\": {\"S\": \"$ACCOUNT_EMAIL\"}}" \
              --region ap-south-1 \
              --query 'Item.control_tower_parameters.M.AccountName.S' \
              --output text 2>/dev/null || echo "NotFound")
            
            if [ "$DDB_ENTRY" != "NotFound" ] && [ "$DDB_ENTRY" != "None" ]; then
              echo "   ‚úÖ Entry found: $DDB_ENTRY"
            else
              echo "   ‚è≥ Entry not yet created"
            fi
            
            # Check 3: AWS Organizations
            echo ""
            echo "3Ô∏è‚É£ Checking AWS Organizations..."
            ORG_ACCOUNT=$(aws organizations list-accounts \
              --query "Accounts[?Email=='$ACCOUNT_EMAIL'].{Id:Id,Status:Status}" \
              --output json 2>/dev/null || echo "[]")
            
            if [ "$ORG_ACCOUNT" != "[]" ] && [ "$ORG_ACCOUNT" != "" ]; then
              ACCOUNT_ID=$(echo "$ORG_ACCOUNT" | jq -r '.[0].Id')
              ACCOUNT_STATUS=$(echo "$ORG_ACCOUNT" | jq -r '.[0].Status')
              
              echo "   ‚úÖ Account found!"
              echo "   üìã ID: $ACCOUNT_ID"
              echo "   üéØ Status: $ACCOUNT_STATUS"
              
              if [ "$ACCOUNT_STATUS" = "ACTIVE" ]; then
                echo ""
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "üéâüéâüéâ ACCOUNT SUCCESSFULLY CREATED! üéâüéâüéâ"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo ""
                echo "‚úÖ Account Name: $ACCOUNT_NAME"
                echo "‚úÖ Account ID: $ACCOUNT_ID"
                echo "‚úÖ Email: $ACCOUNT_EMAIL"
                echo "‚úÖ Status: ACTIVE"
                echo "‚úÖ Time taken: $((i * 2)) minutes"
                echo ""
                ACCOUNT_CREATED=true
                break
              fi
            else
              echo "   ‚è≥ Account not yet created"
            fi
            
            # Wait before next check (if not last iteration)
            if [ $i -lt $MAX_WAIT ]; then
              echo ""
              echo "‚è∞ Waiting 1 minute before next check..."
              sleep 60
            fi
          done
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          if [ "$ACCOUNT_CREATED" = true ]; then
            echo "‚úÖ MONITORING COMPLETE - ACCOUNT ACTIVE"
            echo "account_created=true" >> $GITHUB_ENV
            echo "account_id=$ACCOUNT_ID" >> $GITHUB_ENV
          else
            echo "‚è∞ MONITORING TIMEOUT REACHED"
            echo "   Account creation may still be in progress"
            echo "   Please check manually at:"
            echo "   https://console.aws.amazon.com/organizations/v2/home/accounts"
            echo "account_created=false" >> $GITHUB_ENV
          fi
      
      - name: üéâ Final Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üéâ Account Request Processed!
          
          ### üìã Account Information
          | Field | Value |
          |-------|-------|
          | **Name** | ${{ inputs.account_name }} |
          | **Email** | ${{ inputs.account_email }} |
          | **OU** | ${{ inputs.organizational_unit }} |
          | **Environment** | ${{ inputs.environment }} |
          | **Requested By** | @${{ github.actor }} |
          EOF
          
          if [ "${{ env.account_created }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ‚úÖ Account Successfully Created!
          
          | Detail | Value |
          |--------|-------|
          | **Account ID** | ${{ env.account_id }} |
          | **Status** | ACTIVE |
          | **Creation Time** | ~20 minutes |
          
          ### üéØ Next Steps
          - Access account via [AWS SSO Portal](https://d-906702c4e1.awsapps.com/start)
          - Account is ready to use immediately
          - Control Tower baseline applied automatically
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ‚è∞ Account Creation In Progress
          
          The account is still being provisioned. This can take up to 30 minutes.
          
          **Monitor Progress:**
          - [CodePipeline](https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view)
          - [AWS Organizations](https://console.aws.amazon.com/organizations/v2/home/accounts)
          - [Step Functions](https://ap-south-1.console.aws.amazon.com/states/home?region=ap-south-1)
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ---
          ü§ñ **Automated by AFT** | üîí **Secured by Control Tower**
          EOF

